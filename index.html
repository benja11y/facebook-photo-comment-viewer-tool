<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Facebook Photo Comment Viewer - Landing</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Facebook Photo Comment Viewer</h1>
  <section>
    <h2>Instructions</h2>
    <p><!-- Placeholder for instructions --></p>
  </section>
  <section>
    <h2>Step 1: Get the Bookmarklet</h2>
    <a href='javascript:(function(){"use strict";function findCoreContainers(){console.log("--- Finding Core Containers ---"),console.log("Searching for date permalink...");var complementaryElement=document.querySelector("div[role=\"complementary\"]");if(!complementaryElement)return console.error("Could not find the element with role='complementary'. Orientation failed."),null;console.log("Found complementary element:",complementaryElement);var e=Array.from(complementaryElement.querySelectorAll("a")).find(e=>e.href.includes("/photo/"));if(!e)return console.error("Could not find the unique date permalink containing '/photo/' within the complementary element. Orientation failed."),null;console.log("Found date permalink element:",e),console.log("Searching for first comment article...");var t=document.querySelector("div[role=\"article\"]");if(!t)return console.error("Could not find any comment articles. Orientation failed."),null;console.log("Found first comment article:",t);var o=new Set,n=e.parentElement;for(;n;)o.add(n),n=n.parentElement;var r=null;for(n=t.parentElement;n;){if(o.has(n)){var l=Array.from(n.children).filter(e=>"DIV"===e.tagName);if(4===l.length){r=n;break}}n=n.parentElement}if(!r)return console.error("Could not find a common ancestor with 4 DIV children."),null;var l=Array.from(r.children).filter(e=>"DIV"===e.tagName);return{headerDiv:l[0],statsDiv:l[1],commentsDiv:l[3],datePermalink:e}}function scrapeMainPhoto(){console.log("Attempting to find the visible div[role='main'] containing the image...");var e=document.querySelectorAll("div[role=\"main\"]");if(0===e.length)return console.log("No div[role='main'] elements found."),"PHOTO_URL_NOT_FOUND_NO_MAIN_DIV";var t='img[data-visualcompletion=\"media-vc-image\"]',o=null;for(let n=0;n<e.length;n++){let r=e[n];if(r.offsetHeight>0||r.clientHeight>0){console.log(`Checking visible div[role='main'] #${n+1}:`,r);let l=r.querySelector(t);if(l){o=l.src;console.log("Image found in visible div[role='main']:",l);break}}}if(!o)return console.log("Image not found in any visible div[role='main'] with selector:",t),"PHOTO_URL_NOT_FOUND_NO_IMAGE_IN_VISIBLE_MAIN_DIV";return o}function scrapePostDate(e){if(!e)return"DATE_NOT_FOUND";var t=Array.from(e.querySelectorAll("span")).filter(e=>1===e.textContent.trim().length);if(0===t.length)return e.textContent.trim()||"DATE_NOT_FOUND";var o=t.map(e=>{var t=e.getBoundingClientRect();return{text:e.textContent,y:t.top,x:t.left}});o.sort((e,t)=>Math.abs(e.y-t.y)>5?e.y-t.y:e.x-t.x);if(o.length>0){var n=o[0].y;return o.filter(e=>Math.abs(e.y-n)<5).reduce((e,t,o,n)=>{const r=t.text;if(0===o)return r;const l=n[o-1].text;return/\d/.test(l)!==/\d/.test(r)?e+" "+r:e+r},"")}return"DATE_NOT_FOUND"}function scrapePostAuthorAndMeta(e,t){if(!e)return{postAuthor:"AUTHOR_NOT_FOUND",postLocation:"LOCATION_NOT_FOUND"};var o=e.querySelector("h2 a"),n=o?o.textContent.trim():"AUTHOR_NOT_FOUND",r="LOCATION_NOT_FOUND",l=Array.from(e.querySelectorAll("a")).find(e=>e!==o&&e!==t&&e.textContent.trim().length>0);return l&&(r=l.textContent.trim()),{postAuthor:n,postLocation:r}}function scrapeEngagement(e){var t={firstLiker:"",otherCount:0},o=0;if(!e)return{likes:t,totalComments:o};var n=e.innerText,r=n.match(/\d+/g);r&&r.length>0&&(t.otherCount=parseInt(r[0],10)||0,r.length>1?o=parseInt(r[r.length-1],10)||0:/comment/i.test(e.innerText)&&(o=t.otherCount,t.otherCount=0));var l=e.querySelector('[aria-label*="See who reacted"]');if(l){var s=l.innerText.trim();if(s){var a=s.match(/(.+) and ([\d,]+) others?/);a?(t.firstLiker=a[1].trim(),t.otherCount=parseInt(a[2].replace(/,/g,""),10)):/^\d+$/.test(s)||(t.firstLiker=s)}}return{likes:t,totalComments:o}}function scrapeCommentsAndAvatars(e,t){var o={};if(!e)return{comments:[],avatars:o};var n=e.querySelectorAll("div[role=\"article\"]"),r=document.querySelector("h2 a")?.closest(".x1cy8zhl")?.querySelector("image");r&&"AUTHOR_NOT_FOUND"!==t&&(o[t]=r.getAttribute("xlink:href"));var l=Array.from(n).map(t=>{let n=0,r=t;for(;r&&r!==e;)n++,r=r.parentElement;var l=t.getAttribute("aria-label")||"",s=l.match(/by (.*?)(?: to .*'s comment| \d+)/),a=s?s[1].trim():null,i=t.querySelector("div[dir=\"auto\"]"),c=a&&i?i.innerText.trim():null,d=t.querySelector("image")?.getAttribute("xlink:href");return c?(d&&!o[a]&&(o[a]=d),{commentObject:{name:a,message:c},depth:n}):null}).filter(Boolean);if(0===l.length)return o.fallback="https://placehold.co/32x32/FFFFFF/000000?text=A",{comments:[],avatars:o};var s=[],a=[];return l.forEach(e=>{const{commentObject:t,depth:o}=e;for(;a.length>0&&o<=a[a.length-1].depth;)a.pop();a.length>0?(a[a.length-1].commentObject.replies||(a[a.length-1].commentObject.replies=[]),a[a.length-1].commentObject.replies.push(t)):s.push(t),a.push({commentObject:t,depth:o})}),(function e(t){t.forEach(t=>{t.replies&&t.replies.length>0?e(t.replies):delete t.replies})})(s),o.fallback="https://placehold.co/32x32/FFFFFF/000000?text=A",{comments:s,avatars:o}}function finalizeAndCopy(e){var t=JSON.stringify(e,null,2);navigator.clipboard.writeText(t).then(()=>{alert("Facebook post data copied to clipboard!")}).catch(e=>{console.error("Failed to copy data to clipboard:",e),alert("Failed to copy data. See the browser console for details.")})}function runScraper(){try{console.log("--- Starting Facebook Page Scraper v7.2 ---");var e=findCoreContainers();if(!e)return void alert("Scraper could not orient itself on the page. Core containers not found. Check console.");var{headerDiv:t,statsDiv:o,commentsDiv:n,datePermalink:r}=e,{postAuthor:l,postLocation:s}=scrapePostAuthorAndMeta(t,r),a=scrapePostDate(r),{likes:i,totalComments:c}=scrapeEngagement(o),{comments:d,avatars:m}=scrapeCommentsAndAvatars(n,l),p=scrapeMainPhoto();finalizeAndCopy({mainPhotoUrl:p,postAuthor:l,postDate:a,postLocation:s,likes:i,totalComments:c,avatars:m,comments:d})}catch(e){console.error("The Facebook scraper bookmarklet failed to run:",e),alert("The scraper could not run successfully. Check the console for errors. The page structure may have changed.")}}runScraper();})();' id="bookmarklet-link">Drag this to your bookmarks bar: Facebook Scraper</a>
  </section>
  <section>
    <h2>Step 2: Paste JSON Output</h2>
    <textarea id="json-input" rows="12" cols="80" placeholder="Paste JSON here"></textarea>
    <br>
    <button id="open-viewer-btn">Open Viewer</button>
  </section>
  <script>
    document.getElementById('open-viewer-btn').addEventListener('click', function() {
      const json = document.getElementById('json-input').value.trim();
      if (!json) {
        alert('Please paste the JSON output from the bookmarklet.');
        return;
      }
      try {
        JSON.parse(json);
      } catch (e) {
        alert('Invalid JSON. Please check your input.');
        return;
      }
      localStorage.setItem('fb_photo_comment_json', json);
      window.open('viewer.html', '_blank');
    });
  </script>
</body>
</html>